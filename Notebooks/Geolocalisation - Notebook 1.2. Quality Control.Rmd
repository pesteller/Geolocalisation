---
title: "Geolocalisation - Notebook 1.2 Quality Control"
output:
  pdf_document: default
  html_notebook: default
---

This is an R Markdown Notebook used for plotting the data used in the project after filtering.

```{r}
# Set working directory
setwd("~/Documents/Postgrau_DSML/Geolocalisation/")

# Load libraries
library(data.table)
library(dplyr)
library(ggplot2)

# Load genomic data
df_c2 <- fread("pkl/df_c2_filtPos80filtSamp70_meanval.csv.gz", header = T, drop = 1) # Load all data
df_c2_rownames <- fread("pkl/df_c2_filtPos80filtSamp70_meanval.csv.gz", header = T, select = 1) # Load first column (aka rownames, which is the name of the sample)
rownames(df_c2) <- df_c2_rownames$V1
rm(df_c2_rownames)
df_c2$Sample <- rownames(df_c2) # Add a column with the row names in df_c2

# Load Sample localisation data
geo <- fread("data/Sample_localisation_extended.csv", header = T)
```

1. Assessing the relationship between Subspecies and SamplingSites
Since the density of the samples across the different sampling sites will have an effect in our prediction. Here we will plot the number of samples for each subspecies and sampling sites.
```{r}
# Assign color to subspecies so that the plots match the colouring in Fontsere et al. 2022
my.Subspecies <- c("Central", "Eastern", "Nigeria-Cameroon", "Western")
my.cols <- c("forestgreen", "tan2", "hotpink3", "steelblue3")
names(my.cols) <- my.Subspecies

ggplot(merged, aes(x = Subspecies, fill = Subspecies)) +
  geom_bar(col = "black", show.legend = FALSE) +
  labs(x=NULL, y="Count") +
  ggtitle("Number of samples per subpecies") +
  scale_fill_manual(values = my.cols) +
  theme_classic(base_size=15) +
  theme(legend.title = element_blank(), axis.text.x = element_text(hjust = 1, angle = 90),
        axis.text = element_text(colou = "black"))

ggplot(merged, aes(x = SamplingSite, fill = Subspecies)) +
  geom_bar(col = "black", show.legend = FALSE) +
  facet_wrap(~Subspecies, scales = "free")+
  labs(x=NULL, y="Count") +
  ggtitle("Number of samples per sampling site") +
  scale_fill_manual(values = my.cols) +
  theme_classic(base_size=10) +
  theme(legend.title = element_blank(), axis.text.x = element_text(hjust = 1, angle = 90),
        axis.text = element_text(colou = "black"))
```

2. Principal Component Analysis (PCA)
We will perform PCA in order to check the impact that the filtering applied to the data might have had in our samples. If the analysis has been so stringent so as to remove the biological meaning of our data, samples should not cluster by subspecies.

Performing PCA on our data.
```{r}
merged <- merge(x = df_train_c, y = geo, by.x = "Sample", by.y = "ExtractID") # Merge both dataset by the sample name (in df_train_c it is called "Sample" and in geo it is called "ExtractID")

pca_res <- prcomp(merged[,2:238068]) # pcrcompr of a selected number of columns (the last ones, which are excluded, have information about the Sample_location)
var_explained <- pca_res$sdev^2/sum(pca_res$sdev^2) # Calculate the variance explained by each component
```

Write function for plotting PCA and coloring it depending on different characteristics (subspecies, samplingsite, country, ...)
````{r}
plotPCA <- function(group, component1, component2) {
  library(dplyr)
  library(ggplot2)

  coord <- as.numeric(which(colnames(merged) == group))
  data2plot <- cbind(data.frame(pca_res$x), data.frame(merged)[,coord])
  colnames(data2plot)[ncol(data2plot)] <- group
  
  if (group == "Subspecies") {
    p <- ggplot(data2plot, aes(x = data2plot[,component1], 
                               y = data2plot[,component2], 
                               fill = data2plot[,ncol(data2plot)])) +
      geom_point(size = 4, colour = "black", shape = 21, alpha = 0.75) +
      labs(x=paste0("PC",component1," (",round(var_explained[component1]*100,1),"%)"),
           y=paste0("PC",component2," (",round(var_explained[component2]*100,1),"%)")) +
      ggtitle(paste0(group, " (n = ",nrow(pca_res$x)," samples)")) +
      scale_fill_manual(values = my.cols) +
      theme_classic(base_size=10) +
      theme(legend.title = element_blank())
    
  } else {
    p <- ggplot(data2plot, aes(x = data2plot[,component1], 
                               y = data2plot[,component2], 
                               fill = data2plot[,ncol(data2plot)])) +
      geom_point(size = 4, colour = "black", shape = 21, alpha = 0.75) +
      labs(x=paste0("PC",component1," (",round(var_explained[component1]*100,1),"%)"),
           y=paste0("PC",component2," (",round(var_explained[component2]*100,1),"%)")) +
      ggtitle(paste0(group, " (n = ",nrow(pca_res$x)," samples)")) +
      theme_classic(base_size=10) +
      theme(legend.title = element_blank())
  }
  
  return(p)
}

```

2.1. PCA on Subspecies: the four subspecies follow clustering pattern expected and so all subspecies can be separated. This indicates that the filtering we have perfomed in the dataset has to had a negative impact in the data, since a biological meaning can still be retrieved.
````{r}
plotPCA(group = "Subspecies", component1 = 1, component2 = 2)
plotPCA(group = "Subspecies", component1 = 3, component2 = 4)
```

2.2. PCA on Country: as expected, no substructure is seen if we plot the PCA by country. As most sampling sites span different countries and some countries might harbor samples from different subspecies.  
````{r}
plotPCA(group = "Country", component1 = 1, component2 = 2)
plotPCA(group = "Country", component1 = 3, component2 = 4)
```

2.3. PCA on Sampling site: no substructure is seen in the first components of the PC if we plot the PCA by sampling site. This is also to be expected, since PCA captures common variation in the first components and so we expect private positions to be driving sampling site substructure. As such, we could only expect the PC to start distinguishing sampling sites in bigger PCs. This can be seen if we plot the PC5 vs PC6. 
start seeing sampling sites if larger PC. 
````{r}
plotPCA(group = "SamplingSite", component1 = 1, component2 = 2)
plotPCA(group = "SamplingSite", component1 = 3, component2 = 4)
plotPCA(group = "SamplingSite", component1 = 5, component2 = 6)
```

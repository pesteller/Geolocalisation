---
title: "HairsProject Overview"
author: Marina

output:
  html_document:
    toc: true
    theme: united
    highlight: tango
          
---

```{r, include = FALSE, echo = FALSE}
#output:
#  prettydoc::html_pretty:
#    theme: cayman
```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, include = FALSE}
library("tidyverse")
library ("readxl")
library("ggplot2")
library("forcats")
library("scales")
library("data.table")
library("knitr")
library("ggpubr")
library("gridExtra")
library("ggrepel")
library(treemap) 
library("writexl")
library("DT")

paletteCaptSeq <- c("#4F6367", "#7A9E9F", "#B8D8D8", "#FE5F55") # (1) Production Reads, (2) Mapped Reads, (3) Reliable Reads, (4) Reliable On Target Reads

ReadsOrder <- c("ProductionReads", "MappedReads", "ReliableReads")

themeMAE <- theme(# plotting components
      ## drop minor gridlines
      panel.grid.minor = element_blank(),
      # change grid lines to gray
      panel.grid.major =  element_line(color = "#d0d0d0", size = .2),
      # fill the plot and panel spaces with grey and remove border
      panel.background = element_rect(fill = "#f0f0f0", color = NA),
      plot.background = element_rect(fill = "#f0f0f0", color = NA),
      panel.border = element_blank(),
      # remove strip background
      strip.background = element_blank(),
      # adjust the margins of plots and remove axis ticks
      plot.margin = margin(0.5, 1, 0.5, 1, unit = "cm"),
      axis.ticks = element_blank(),
      # change text family, size, and adjust position of titles
      #text = element_text(family = "Chivo"),
      #text = element_text(family = "Arial"),
      axis.text = element_text(face = "bold", color = "darkgrey"),
      axis.title = element_text(size = rel(1.33)),#face = "bold", 
      axis.title.x = element_text(margin = margin(0.5, 0, 0, 0, unit = "cm")),
      axis.title.y = element_text(margin = margin(0, 0.5, 0, 0, unit = "cm"), angle =90),
      plot.title = element_text(face = "bold", size = rel(1.67), hjust = 0),
      plot.title.position = "plot",
      plot.subtitle = element_text(size = 16, margin = margin(0.2, 0, 1, 0, unit = "cm"), hjust = 0),
      plot.caption = element_text(size = 10, margin = margin(1, 0, 0, 0, unit = "cm"), hjust = 1),
      strip.text = element_text(size = rel(1.33), face = "bold"),
      #change legend
      legend.position = "none",
      #legend.background = element_rect(fill = "#f0f0f0", color = NA),
      #legend.direction = "horizontal"
    )

OrderSitesALL <- c("Afi Mountain", "Mbe", "Cross River National Park", "Boshi", "Takamanda", "Kagwene", "Kenshi", "Deng Deng", "Dzanga-Sangha?", "Lobéké", "Monte Alen", "Ngaga Camp", "Mt Dou Dou", "Unknown_1", "Unknown_2", "Unknown_3")
OrderSitesWG <- c("Afi Mountain", "Mbe", "Cross River National Park", "Boshi", "Takamanda", "Kagwene", "Kenshi")
OrderSitesCR <- c("Deng Deng", "Dzanga-Sangha?", "Lobéké", "Monte Alen", "Ngaga Camp", "Mt Dou Dou")
OrderSitesUN <- c("Unknown_1", "Unknown_2", "Unknown_3")
OrderSitesNotCont <- c("Afi Mountain", "Mbe", "Kagwene", "Kenshi", "Deng Deng", "Dzanga-Sangha?", "Lobéké", "Monte Alen", "Ngaga Camp", "Mt Dou Dou", "Unknown_1", "Unknown_3")
OrderSitesNotContAb10 <- c("Afi Mountain", "Kenshi", "Unknown_1")
OrderSitesNotContAb7 <- c("Afi Mountain", "Mbe", "Kenshi", "Unknown_1")
OrderSitesNotContAb2 <- c("Afi Mountain", "Mbe", "Kagwene", "Kenshi", "Deng Deng", "Monte Alen", "Ngaga Camp",  "Unknown_1")
```

Hairs database
```{r, warning=FALSE, error=FALSE}

# Samples dataframe
DF <- read_xlsx("Metadata_Sites.xlsx", sheet = "Sample_MD", col_names = TRUE)
#head(DF)

# Sites information
sitesDF <- read_xlsx("Metadata_Sites.xlsx", sheet = "Sites", col_names = TRUE)
#head(sitesDF)

# Merged dataframe of Samples and Sites
DF_sites <- merge(DF, sitesDF, by = "Site")
#DF_sites
```


# Questions I want to answer:

1. How many samples are there in the project?

```{r, echo=FALSE}
DF %>% summarise(Total_number_of_samples=n_distinct(BCN_ID))
```

2. How many samples in TMB lab and how many in NYU
```{r}
DF_sites %>% group_by(Lab) %>%
  summarise(Samples_by_Lab = n_distinct(BCN_ID))
```

3. How many samples I have per species and site?
```{r}
DF_sites %>%
  group_by(Species) %>%
  summarise(Count = n_distinct(BCN_ID))

countsSiteSPecies <- DF_sites %>%
  group_by(Species, Site) %>%
  summarise(Count = n_distinct(BCN_ID))
countsSiteSPecies

```

```{r treemap-Species}
#Option 1
treemap(countsSiteSPecies,
            index="Species",
            vSize="Count", 
            type="index",
            border.col = "white", title = ""
            )
```

```{r treemap-SpeciesSite}
treemap(countsSiteSPecies,
            index=c("Species","Site"),
            vSize="Count", 
            type="index",
            border.col = "white", title = "", 
            )
```

4. Of the total samples, how many were used for DNA extraction?

```{r}

# Samples not used for DNA extraction are IDs "NA" in the "Extraction_ID" column.
DF_sites %>% filter(Extraction_ID == "NA") %>% 
  summarise(n_distinct(BCN_ID))
```
There are 3 samples that were not found/used for DNA extraction. It means that 131-3 = 128 samples were extracted


5. How many samples have been used to prepare libraries?
```{r}
DF_sites %>% group_by(Used) %>%
  summarise(n_distinct(BCN_ID))

DF_sites %>% group_by(Used, Site) %>%
  summarise(n_distinct(BCN_ID))
```

Of the 131 total samples, 11 have not been used for library prep (due to missing sample or used mnultiple haris per extraction, etc.). This results in a total of 120 samples.
For 1 sample, CRN1, we had 2 libraries prepared, this is what gives the = 121 total libraries.

There are 5 libraries¡ part of SRSLY1 batch, shallow sequenced by ClaretBio and identified as contaminated with the HuConTest. In this first SRSLY1 batch there were 3 more libraries that were not detected as human contaminated and therefore further sequenced in SRSLY2 batch.
This means that the final list of libraries is 121, but only 116 to high depth (if we remove the 5 contaminated and sallow sequenced from SRSLY1)


6. Map of the sequenced libraries
```{r, warning=FALSE, error=FALSE, echo = FALSE}
library("rgdal") 
library('maps')
library('mapdata')
library('maptools')
library("ggplot2")
library("readxl")
library("rgdal") 

#Plain map files
map <- readOGR ("../Maps/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp")
rivers <- readOGR ("../Maps/ne_110m_rivers_lake_centerlines/ne_110m_rivers_lake_centerlines.shp")
lakes <- readOGR ("../Maps/ne_110m_lakes/ne_110m_lakes.shp")
ocean <- readOGR ("../Maps/ne_50m_ocean/ne_50m_ocean.shp")
AfRivers <- readOGR("../Maps/africa_rivers_1/africa_rivers_1.shp") # African rivers

#Distribution ranges
WL1 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_WesternLowland1.shp")
WL2 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_WesternLowland2.shp")
CR1 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_CrossRiver1.shp")
CR2 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_CrossRiver2.shp")
EL1 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_EasternLowland1.shp")
EL2 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_EasternLowland2.shp")
EL3 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_EasternLowland3.shp")
EL4 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_EasternLowland4.shp")
MG1 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_Mountain1.shp")
MG2 <- readOGR("../Samples Info/MapShapeFiles/SPECIES_Mountain2.shp")
CR_1 <-readOGR("../Maps/CrossRiverDistrution/AfiMountain")
CR_2 <-readOGR("../Maps/CrossRiverDistrution/Between Mbulu&Kagwene")
CR_3 <-readOGR("../Maps/CrossRiverDistrution/Boshi")
CR_4 <-readOGR("../Maps/CrossRiverDistrution/KagweneMountain")
CR_5 <-readOGR("../Maps/CrossRiverDistrution/MbeMountains")
CR_6 <-readOGR("../Maps/CrossRiverDistrution/MoneEast")
CR_7 <-readOGR("../Maps/CrossRiverDistrution/MoneNorth")
CR_8 <-readOGR("../Maps/CrossRiverDistrution/NearWL")
CR_9 <-readOGR("../Maps/CrossRiverDistrution/Okwango-Takamanda")
CR_10 <-readOGR("../Maps/CrossRiverDistrution/TakamandaEast")
CR_11 <-readOGR("../Maps/CrossRiverDistrution/TakamandaNorth")
CR_12 <-readOGR("../Maps/CrossRiverDistrution/TakamandaNorthNorth")
CR_13 <-readOGR("../Maps/CrossRiverDistrution/TakamandaSouth")
CR_14 <-readOGR("../Maps/CrossRiverDistrution/UpperMbulu")
```

```{r, echo = FALSE, out.width= "100%}

#Plain Map
BaseMap <- ggplot() + geom_polygon(data = map, aes(x = long,y = lat, group = group),fill = "wheat1",size=0.3) + #wheat1
  geom_path(data = map,aes(x = long,y = lat,group = group),colour = "wheat4",size=1) + 
  #labs(x = "Longitude", y = "Latitude") + coord_cartesian(xlim = c(0, 25), ylim = c(-10, 15)) + 
  labs(x = "Longitude", y = "Latitude") + coord_cartesian(xlim = c(5, 20), ylim = c(-5, 10)) + 
  theme(panel.background = element_rect(fill = 'skyblue4'),panel.grid.major = element_blank(),panel.grid.minor = element_blank())
BaseMap <- BaseMap + geom_polygon(data=lakes,aes(x = long,y = lat,group = group),fill = "skyblue4",size=0.3) + 
  geom_path(data = lakes,aes(x = long,y = lat,group = group),colour = "lightskyblue3",size=0.5)
BaseMap <- BaseMap + geom_path(data=AfRivers, aes(x = long,y = lat,group = group), color = "lightskyblue3", size=0.1) +
  geom_polygon(data=ocean, aes(x = long,y = lat,group = group),fill = "skyblue4",size=0.3) + 
  geom_path(data=ocean, aes(x = long,y = lat,group = group),colour = "skyblue4",size=0.7)

```


```{r MapAllSpecies, out.width="100%", echo = FALSE}
# 4 subspecies map

# countries
Countries <- data.frame(lon=c(7.5, 12.0, 19.0, 
                              10.5, 12.0, 16.0, 
                              23.0, 31.0, 30.0, 30.0),
                       lat=c(7.0, 6.0, 6.0, 
                             1.6,-0.8, 0, 
                             0.0,  0.0, -2.0, -3.1),
                       name=c("Nigeria", "Cameroon", "Central African Republic", 
                              "Equatorial\nGuinea", "Gabon", "Republic\nof the\nCongo", 
                              "Democratic Republic\nof the Congo", "Uganda", "Rwanda", "Burundi"))


BaseMap_4Dist <- BaseMap + 
  geom_polygon(data=WL1, aes(x=long, y=lat), fill = "#ae4544", color = "#ae4544", size=0.1, alpha=0.5) +
  geom_polygon(data=WL2, aes(x=long, y=lat), fill = "#ae4544", color = "#ae4544", size=0.1, alpha=0.5) +
  #geom_polygon(data=CR1, aes(x=long, y=lat), fill = "#a4ad6f", color = "#a4ad6f", size=0.1, alpha=0.5) +
  #geom_polygon(data=CR2, aes(x=long, y=lat), fill = "#a4ad6f", color = "#a4ad6f", size=0.1, alpha=0.5) +
  geom_polygon(data=CR_1, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_2, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_3, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_4, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_5, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_6, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_7, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_8, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_9, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_10, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_11, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_12, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_13, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_14, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=EL1, aes(x=long, y=lat), fill="#A4AD6F", color = "#A4AD6F", alpha = .5) +
  geom_polygon(data=EL2, aes(x=long, y=lat), fill="#A4AD6F", color = "#A4AD6F", alpha = .5) +
  geom_polygon(data=EL3, aes(x=long, y=lat), fill="#A4AD6F", color = "#A4AD6F", alpha = .5) +
  geom_polygon(data=EL4, aes(x=long, y=lat), fill="#A4AD6F", color = "#A4AD6F", alpha = .5) +
  geom_polygon(data=MG1, aes(x=long, y=lat), fill="#CC7C3A", color = "#CC7C3A", alpha = .5) +
  geom_polygon(data=MG2, aes(x=long, y=lat), fill="#CC7C3A", color = "#CC7C3A", alpha = .5) +
  coord_cartesian(xlim = c(5, 32), ylim = c(-5, 7)) + 
  #themeMAE + #theme(axis.text = element_blank()) +
  geom_text(data = Countries, aes( x = lon, y = lat, label = name), 
                   size = 6, color = "gray29")
BaseMap_4Dist 
```

```{r}

# countries Western Gorillas
CountriesWesterns <- data.frame(lon=c(7.5, 12.0, 19.0, 
                              10.5, 12.0, 16.0),
                       lat=c(7.0, 6.0, 6.0, 
                             1.6,-0.8, 01),
                       name=c("Nigeria", "Cameroon", "Central African Republic", 
                              "Equatorial\nGuinea", "Gabon", "Republic\nof the\nCongo"))

#Add gorillas distributions
BaseMap <- BaseMap + 
  geom_polygon(data=WL1, aes(x=long, y=lat), fill = "#ae4544", color = "#ae4544", size=0.1, alpha=0.5) +
  geom_polygon(data=WL2, aes(x=long, y=lat), fill = "#ae4544", color = "#ae4544", size=0.1, alpha=0.5) +
  geom_polygon(data=CR1, aes(x=long, y=lat), fill = "#a4ad6f", color = "#a4ad6f", size=0.1, alpha=0.5) +
  geom_polygon(data=CR2, aes(x=long, y=lat), fill = "#a4ad6f", color = "#a4ad6f", size=0.1, alpha=0.5) +
  geom_polygon(data=CR_1, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_2, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_3, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_4, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_5, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_6, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_7, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_8, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_9, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_10, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_11, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_12, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_13, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) +
  geom_polygon(data=CR_14, aes(x=long, y=lat), fill = "#7c5981", color = "#7c5981", alpha = .5) + 
  geom_text(data = CountriesWesterns, aes( x = lon, y = lat, label = name), 
                   size = 6) +
  themeMAE 
BaseMap
```

```{r, out.width = "100%", echo = FALSE}
# Merge Sites general coordinates wiht the dataframe


# Get count of samples by site
AllSamplMap <- DF_sites %>% 
  group_by(Species, Site) %>%
  summarise(n_distinct(BCN_ID), `Site Lat`, `Site Long`) %>%
  as.data.frame() %>% unique()
AllSamplMap$`Site Lat` <- as.numeric(AllSamplMap$`Site Lat`)
AllSamplMap$`Site Long` <- as.numeric(AllSamplMap$`Site Long`)

# All sites map
allSites <- BaseMap + 
  geom_point(data = AllSamplMap, 
                  aes(x = `Site Long`, y = `Site Lat`, group = Site)) +
  geom_text_repel(data = AllSamplMap, aes(x = `Site Long`, y = `Site Lat`, label = Site), size = 3,
        nudge_x = c(-0.5, -0.5, -0.5, .5, .5), nudge_y = c(0.5, -0.5, 0.5, 0.5, -0.5)) +
  coord_fixed(xlim = c(5, 20), ylim = c(-5, 10)) + 
  themeMAE + theme(legend.position = c(.2,.05), legend.direction = "horizontal", 
                   legend.background = element_rect(fill = "#f0f0f0", color = NA), 
                   axis.text = element_blank()) + xlab("") + ylab("")
allSites


# Cross River Gorilla - Zoom
AllSampMapCR <- AllSamplMap %>% filter(Species == "Cross River Gorilla") 
allSitesCR <- BaseMap + 
  geom_point(data = AllSampMapCR, 
                  aes(x = `Site Long`, y = `Site Lat`, group = Site, size = `n_distinct(BCN_ID)`), alpha = .6) +
  geom_text_repel(data = AllSampMapCR, aes(x = `Site Long`, y = `Site Lat`, label = Site), 
        nudge_x = c(-0.5, -0.5, .5, .5, .5), nudge_y = c(0.25, -0.25, 0.5, 0.5, -0.5)) + 
  coord_fixed(xlim = c(8, 10.5), ylim = c(5.25,7)) +
  themeMAE + theme(legend.position = c(.2,.05), legend.direction = "horizontal", 
                   legend.background = element_rect(fill = "#f0f0f0", color = NA), 
                   axis.text = element_blank()) + xlab("") + ylab("") + labs(size='N =') 
allSitesCR

# Western Lowland Map Zoom
AllSampMapWL <- AllSamplMap %>% filter(Species == "Western Lowland Gorilla") 
allSitesWL <- BaseMap + 
  geom_point(data = AllSampMapWL, 
                  aes(x = `Site Long`, y = `Site Lat`, group = Site, size = `n_distinct(BCN_ID)`), alpha = .6) +
  geom_text_repel(data = AllSampMapWL, aes(x = `Site Long`, y = `Site Lat`, label = Site), 
        nudge_x = c(-0.5, -0.5, .5, .5, .5), nudge_y = c(0.25, -0.25, 0.5, 0.5, -0.5)) + 
  #coord_cartesian(xlim = c(8, 19), ylim = c(-6,6)) +
  coord_fixed(xlim = c(8,19), ylim = c(-6,6)) +
  themeMAE + theme(legend.position = c(.12,.05), legend.direction = "horizontal", 
                   legend.background = element_rect(fill = "#f0f0f0", color = NA), 
                   axis.text = element_blank()) + xlab("") + ylab("") + labs(size='N =') 
allSitesWL

AllSampMapWLU <- AllSamplMap %>% filter(!(Species == "Cross River Gorilla"))
allSitesWLU <- BaseMap + 
  geom_point(data = AllSampMapWLU, 
                  aes(x = `Site Long`, y = `Site Lat`, group = Site, size = `n_distinct(BCN_ID)`), alpha = .6) +
  geom_text_repel(data = AllSampMapWLU, aes(x = `Site Long`, y = `Site Lat`, label = Site), 
        nudge_x = c(-0.5, -0.5, .5, .5, .5), nudge_y = c(0.25, -0.25, 0.5, 0.5, -0.5)) + 
  #coord_cartesian(xlim = c(8, 19), ylim = c(-6,6)) +
  coord_fixed(xlim = c(8,19), ylim = c(-5,8)) +
  themeMAE + theme(legend.position = c(.8,.05), legend.direction = "horizontal", 
                   legend.background = element_rect(fill = "#f0f0f0", color = NA), 
                   axis.text = element_blank()) + xlab("") + ylab("") + labs(size='N =') 
allSitesWLU

#scale_color_manual(name = NULL, values = c("Western Lowland Gorilla" = "#ae4544", "Cross River Gorilla" = "#7c5981", "Unknown" = "#436f82")) +
#scale_fill_manual(name = NULL, values = c("Western Lowland Gorilla" = "#ae4544", "Cross River Gorilla" = "#7c5981", "Unknown" = "#436f82")) +
```




# Summary Metrics (SRSLY2 + SRSLY3) - Coverage and HuConTest

```{r, echo = FALSE}

### Summary Metrics
    # SRSLY1
df1 <- fread("../Analyses/02_SummaryMetrics/WG/SumMetrics_SRSLY1_WG_library_FASTP11merge2maxmiss.txt", header = TRUE)
#I add the two missing columns comparet to SRSLY2 and SRSLY3 summary metrics tables. And I also remove the 3 samples that we further sequenced in SRSLY2
GorID <- c("Tak5", "Tak7", "Ken8", "Kag2", "MoA2", "MoA6", "Bai18", "Kag9")
SampleID <- c("BCN115", "BCN117", "BCN019", "BCN002", "BCN061", "BCN065", "BCN081", "BCN009")
df1$GorID <- GorID
df1$Sample_ID <- SampleID
df1mod <- df1 %>% relocate(GorID, .before = Library_ID) %>% relocate(Sample_ID, .after = Library_ID) %>%
  filter(!(grepl('MoA2|MoA6|Bai18', GorID)))

    # SRSLY2
df2 <- fread("../Analyses/02_SummaryMetrics/WG/SumMetrics_SRSLY2_WG_GRCh38_IDsAlluniq.txt", header = TRUE)
    # SRSLY3
df3 <- fread("../Analyses/02_SummaryMetrics/WG/SumMetrics_SRSLY3_WG_GRCh38_IDsAllunique.txt", header = TRUE)
df123 <- rbind(df1mod, df2, df3)

### HuConTest 
    # SRSLY1 (I do the same as with the SummaryMetrics)
dfH1 <- fread("../Analyses/06_HumanContaminationTest/01_HumanContamination/04_SummaryResults_SRSLY1.txt", header = FALSE, col.names = c("LibraryID", "PerCont", "LowLim", "UpLim", "Reads"))
dfH1$GorID <- GorID
dfH1 <- dfH1 %>% relocate(GorID, .before = LibraryID) %>% filter(!(grepl('MoA2|MoA6|Bai18', GorID)))
    # SRSLY2 and SRSLY3
dfH2 <- fread("../Analyses/06_HumanContaminationTest/01_HumanContamination/04_SummaryResults_SRSLY2Windows.txt", header = FALSE, col.names = c("GorID", "LibraryID", "PerCont", "LowLim", "UpLim", "Reads"))
dfH3 <- fread("../Analyses/06_HumanContaminationTest/01_HumanContamination/04_SummaryResults_SRSLY3Down.txt", header = FALSE, col.names = c("GorID", "LibraryID", "PerCont", "LowLim", "UpLim", "Reads"))
dfH123 <- rbind(dfH1, dfH2, dfH3)


#head(df123)
#head(dfH123)
```


```{r, echo = FALSE}
# Merge both datasets, SummaryMetrics and HuConTest results

dfSH <- merge(df123, dfH123, by = "GorID")
dfMet <- merge(dfSH, DF_sites, by.x = "GorID", by.y = "Old_SampleID2")

dfMet <- dfMet[!duplicated(dfMet$LibraryID), ]
```

Summary metrics (totals)
```{r, echo = FALSE, out.width="100%"}
dfMet %>% mutate(ReliableReads = Filtered_Reads,
              MappedReads = Mapped_Reads - Filtered_Reads,
              ProductionReads = Production_Reads - Mapped_Reads) %>%
  select(GorID, Library_ID, Sample_ID, ProductionReads, MappedReads, ReliableReads, SeqBatch) %>%
  gather(key, value, -GorID, -Library_ID, -Sample_ID, -SeqBatch) %>%
  mutate(key = fct_relevel(key, ReadsOrder),
         ID = paste(GorID, Library_ID, sep = '_')) %>%
  ggplot(aes(x = ID, y = value, fill = key, label = key)) +
  geom_bar(stat = "identity") + facet_grid(~SeqBatch, scales = "free", space = "free_x") +
  scale_y_continuous(labels = scales::label_number()) +
  ylab("Number of Reads") +
  scale_fill_manual(values = paletteCaptSeq) +
  themeMAE + xlab("") +
  theme(plot.title.position = "plot",
        legend.position = "bottom", legend.direction = "horizontal", legend.title = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle=45, vjust = 0.5), legend.background = element_rect(fill = "#f0f0f0", color = NA))
```

Summary metrics (percentages)
```{r, echo = FALSE, out.width = "100%"}
dfMet %>% mutate(ReliableReads = Filtered_Reads*100,
              MappedReads = (Mapped_Reads - Filtered_Reads)*100,
              ProductionReads = (Production_Reads - Mapped_Reads)*100) %>%
  select(GorID, Library_ID, Sample_ID, ProductionReads, MappedReads, ReliableReads, SeqBatch) %>%
  gather(key, value, -GorID, -Library_ID, -Sample_ID, -SeqBatch) %>%
  mutate(key = fct_relevel(key, ReadsOrder),
         ID = paste(GorID, Library_ID, sep = '_')) %>%
  ggplot(aes(x = ID, y = value, fill = key, label = key)) +
  geom_bar(position="fill", stat = "identity") + facet_grid(~SeqBatch, scales = "free", space = "free_x") +
  ylab("Percentage of Reads") + xlab("") +
  scale_fill_manual(values = paletteCaptSeq) + themeMAE +
  theme(plot.title.position = "plot", panel.grid.major = element_blank(),
        legend.position = "bottom", legend.direction = "horizontal", legend.title = element_blank(),
        axis.text.x = element_text(angle=45, vjust = 0.5), legend.background = element_rect(fill = "#f0f0f0", color = NA))
```


Get Coverage, HuConTest
```{r}
dfMetCovHu <- dfMet %>% mutate(eDNA = (Filtered_Reads/Production_Reads)*100,
              AverageCoverage = Mapped_BASES/3272116950,
              Contaminated = case_when(PerCont >= 1 ~ "Yes",
                                       TRUE ~"No"),
              ReliableHuConT = case_when(Reads >= 500 ~ "Yes",
                              TRUE ~ "No"),
              CovRange = case_when(AverageCoverage < 1 ~ "< 1x",
                                   AverageCoverage < 5 ~ "< 5x",
                                   AverageCoverage < 10 ~ "< 10x",
                                   TRUE ~ "> 10x"),
              ReliableHuConT = fct_relevel(ReliableHuConT, c("No", "Yes")),
              Contaminated = fct_relevel(Contaminated, c("Yes", "No")),
              CovRange = fct_relevel(CovRange, c("< 1x", "< 5x", "< 10x", "> 10x")),
              Species = fct_relevel(Species, c("Western Lowland Gorilla", "Cross River Gorilla", "Unknown")))


#head(dfMetCovHu)
```

```{r}
datatable(dfMetCovHu, filter = 'top', options = list(
  pageLength = 10, autoWidth = TRUE 
))
```


How is the average coverage of each SRSLY batch? And for SRLSY2+SRSLY3 (the high depth sequenced ones)? 
And how is the coverage separating contaminated and not-contaminated samples?
```{r}
dfMetCovHu %>% group_by(SeqBatch) %>%
  summarise(median = median(AverageCoverage),
            average = mean(AverageCoverage), 
            sd = sd(AverageCoverage),
            n = n(),
            se = sd / sqrt(n))

dfMetCovHu %>% group_by(Contaminated, SeqBatch) %>%
  summarise(median = median(AverageCoverage),
            average = mean(AverageCoverage), 
            sd = sd(AverageCoverage),
            n = n(),
            se = sd / sqrt(n))
```

How is the coverage by for each site?
```{r, out.width = "100%"}
#Count of samples per site
counts <- dfMetCovHu %>% group_by(Contaminated, Site) %>%
  summarise(count = n_distinct(Library_ID),
            median = median(AverageCoverage))

# Change of facet labels for "Contamianted"
supp.labs <- c("Contaminated", "Not Contaminated")
names(supp.labs) <- c("Yes", "No")

# Plotting
ggplot(dfMetCovHu, aes(x = Site, y = AverageCoverage)) +
  geom_violin(aes(color = Species)) +
  geom_point(aes(color = Species)) + 
  facet_grid(.~Contaminated, scales = "free", space = "free_x",
             labeller = labeller(Contaminated = supp.labs)) +
  scale_colour_manual(values = colorRampPalette(c("darkmagenta", "turquoise"))(3)) +
  geom_text(data = counts, aes(x = Site, label = paste("n =", count, "\n", round(median, digits = 1),"x")), y = -1.5, size = 2) +
  ylim(-2,15) +
  themeMAE + ggtitle("Coverage by Contamination status") + ylab("Av Coverage") +
  theme(axis.text.x = element_text(angle = 45, face = "plain", size = 8, hjust = 1, color = "black"),
        panel.grid.major.x = element_blank(),
        legend.position = "top", legend.background = element_rect(fill = "#f0f0f0", color = NA)) #+ annotate("text", x = -0.5, y = -1.5, label = "Median", size = 2)

ggplot(dfMetCovHu, aes(x = Site, y = AverageCoverage)) +
  geom_boxplot(aes(color = Species, fill = Species), alpha = .3) +
  geom_point(aes(color = Species), alpha = .6) + 
  facet_grid(.~Contaminated, scales = "free", space = "free_x",
             labeller = labeller(Contaminated = supp.labs)) +
  scale_colour_manual(values = colorRampPalette(c("darkmagenta", "orange"))(3)) +
  scale_fill_manual(values = colorRampPalette(c("darkmagenta", "orange"))(3)) +
  geom_text(data = counts, aes(x = Site, label = paste("n =", count, "\n", round(median, digits = 1),"x")), y = -1.5, size = 2) +
  ylim(-2,15) +
  geom_hline(yintercept = 1, color = "grey60",  size =.25, linetype = "dashed") +
  themeMAE + ggtitle("Coverage by Contamination status") + ylab("Av Coverage") + xlab("") +
  theme(axis.text.x = element_text(angle = 45, face = "plain", size = 8, hjust = 1, color = "black"),
        panel.grid.major.x = element_blank(),
        legend.position = "top", legend.background = element_rect(fill = "#f0f0f0", color = NA),
        legend.title = element_blank()) 

```

Conuts of smaples by range of coverage
```{r, echo = FALSE}
library(ggchicklet)
# Counts of samples by range of coverage (not contaminated)
dfMetCovHu %>% filter(Contaminated == "No") %>%
  group_by(CovRange) %>%
  mutate(CovRange = fct_relevel(CovRange, rev(c("< 1x", "< 5x", "< 10x", "> 10x"))),
         Species = fct_relevel(Species, rev(c("Western Lowland Gorilla", "Cross River Gorilla", "Unknown")))) %>%
  summarise(count = n_distinct(Library_ID)) %>% as.data.frame() %>%
  ggplot( aes(x = "", y = count, fill = CovRange, label = count)) +
  geom_chicklet(width = .5,radius = unit(20,units = "pt"), position = ggplot2::position_stack(reverse = FALSE), color = "#f0f0f0") +
  geom_text(position = position_stack(vjust = 0.5), color = "#f0f0f0") +
  coord_flip() +
  scale_fill_manual(values = colorRampPalette(c("darkmagenta", "turquoise4"))(4), limits = c("< 1x", "< 5x", "< 10x", "> 10x")) +
  labs( x = NULL, y = NULL, fill = NULL,
    title = "Count of samples by range of coverage") + 
  themeMAE + theme(legend.position = c(.5, .15), legend.direction = "horizontal" , 
                   legend.background = element_rect(fill = "#f0f0f0", color = NA), legend.title = element_blank(),
                   panel.grid.major = element_blank(), axis.text = element_blank()) 

# Same but by species
dfMetCovHu %>% filter(Contaminated == "No") %>%
  group_by(Species, CovRange) %>%
  mutate(CovRange = fct_relevel(CovRange, rev(c("< 1x", "< 5x", "< 10x", "> 10x"))),
         Species = fct_relevel(Species, rev(c("Western Lowland Gorilla", "Cross River Gorilla", "Unknown")))) %>%
  summarise(count = n_distinct(Library_ID)) %>% as.data.frame() %>%
  ggplot( aes(x = Species, y = count, fill = CovRange, label = count)) +
  geom_chicklet(width = .5,radius = unit(3,units = "pt"), position = ggplot2::position_stack(reverse = FALSE), color = "#f0f0f0") +
  geom_text(position = position_stack(vjust = 0.5), color = "#f0f0f0") +
  coord_flip() +
  scale_fill_manual(values = colorRampPalette(c("darkmagenta", "turquoise4"))(4), limits = c("< 1x", "< 5x", "< 10x", "> 10x")) +
  annotate(geom = "text", x = 3.5, y = 0, color = "grey30", 
    label = "Western Lowland Gorilla", hjust = 0, vjust = 1, size = 4) +
  annotate(geom = "text", x = 2.5, y = 0, color = "grey30", 
    label = "Cross River Gorilla", hjust = 0, vjust = 1, size = 4) +
  annotate(geom = "text", x = 1.5, y = 0, color = "grey30", 
    label = "Unknown", hjust = 0, vjust = 1, size = 4) +
  labs(
    x = NULL, y = NULL, fill = NULL,
    title = "Count of samples by range of coverage",
    subtitle = "Separated by subspecies"
  ) + 
  themeMAE + theme(legend.position = c(.7, .15), legend.direction = "horizontal" , 
                   legend.background = element_rect(fill = "#f0f0f0", color = NA), legend.title = element_blank(),
                   panel.grid.major = element_blank(), axis.text = element_blank()) 

# Same but by species and by Site

ann_text <- data.frame(count=c(0,0), Site=c(13.5,12.5), Species = c("Western Lowland Gorilla","Western Lowland Gorilla"), label = c("Ngaga Camp","Mt Dou Dou"))

dfMetCovHu %>% filter(Contaminated == "No") %>%
  group_by(Species, Site, CovRange) %>%
  mutate(CovRange = fct_relevel(CovRange, rev(c("< 1x", "< 5x", "< 10x", "> 10x"))),
         Species = fct_relevel(Species, c("Western Lowland Gorilla", "Cross River Gorilla", "Unknown"))) %>%
  summarise(count = n_distinct(Library_ID)) %>% as.data.frame() %>%
  ggplot( aes(x = Site, y = count, fill = CovRange, label = count)) +
  geom_chicklet(width = .4,radius = unit(3,units = "pt"), position = ggplot2::position_stack(reverse = FALSE), color = "#f0f0f0") +
  geom_text(position = position_stack(vjust = 0.5), color = "#f0f0f0") +
  coord_flip() + facet_grid(Species~., scales = "free", space = "free", switch = "y") +
  scale_fill_manual(values = colorRampPalette(c("darkmagenta", "turquoise4"))(4), limits = c("< 1x", "< 5x", "< 10x", "> 10x")) +
  #annotate(geom = "text", x = 3.5, y = 0, color = "grey30", label = "Western Lowland Gorilla", hjust = 0, vjust = 1, size = 4) +
  #annotate(geom = "text", x = 2.5, y = 0, color = "grey30", label = "Cross River Gorilla", hjust = 0, vjust = 1, size = 4) +
  #annotate(geom = "text", x = 1.5, y = 0, color = "grey30", label = "Unknown", hjust = 0, vjust = 1, size = 4) +
  labs(x = NULL, y = NULL, fill = NULL,
    title = "Count of samples by range of coverage",
    subtitle = "Separated by site") + 
  themeMAE + theme(legend.position = c(.7, .1), legend.direction = "horizontal" , strip.placement = "outside",
                   legend.background = element_rect(fill = "#f0f0f0", color = NA), legend.title = element_blank(),
                   panel.grid.major = element_blank())#, axis.text = element_blank()) 
```



How many samples (not contaminated) are above or below 1x coverage (per site)?
```{r, echo = FALSE, out.width = "100%"}

#Count of samples per site
dfMetCovHu %>% filter(Contaminated == "No") %>%
  mutate(x = case_when(CovRange == "< 1x" ~ "Below 1x",
                       TRUE ~ "Above 1x")) %>%
  group_by(x) %>%
  summarise(count = n_distinct(Library_ID),
            median = median(AverageCoverage))

counts2 <- dfMetCovHu %>% filter(Contaminated == "No") %>%
  mutate(x = case_when(CovRange == "< 1x" ~ "Below 1x",
                       TRUE ~ "Above 1x")) %>%
  group_by(x, Site) %>%
  summarise(count = n_distinct(Library_ID),
            median = median(AverageCoverage))

dfMetCovHu %>% filter(Contaminated == "No") %>%
  mutate(x = case_when(CovRange == "< 1x" ~ "Below 1x",
                       TRUE ~ "Above 1x")) %>%
  ggplot( aes(x = Site, y = AverageCoverage)) +
  geom_boxplot(aes(color = Species, fill = Species), alpha = .3) +
  #geom_point(aes(color = Species), alpha = .6) + 
  facet_grid(.~x, scales = "free", space = "free_x") +
  scale_colour_manual(values = colorRampPalette(c("darkmagenta", "orange"))(3)) +
  scale_fill_manual(values = colorRampPalette(c("darkmagenta", "orange"))(3)) +
  geom_text(data = counts2, aes(x = Site, label = paste("n =", count, "\n", round(median, digits = 1),"x")), y = -1.5, size = 2) +
  ylim(-2,15) +
  geom_hline(yintercept = 1, color = "grey60",  size =.25, linetype = "dashed") +
  themeMAE + ggtitle("Coverage of samples above and below 1x") + ylab("Av Coverage") + xlab("") +
  theme(axis.text.x = element_text(angle = 45, face = "plain", size = 8, hjust = 1, color = "black"),
        panel.grid.major.x = element_blank(),
        legend.position = "top", legend.background = element_rect(fill = "#f0f0f0", color = NA),
        legend.title = element_blank()) 
```


```{r, echo = FALSE, out.width = "100%"}


dfMetCovHu %>% group_by(Contaminated) %>%
  summarise(n_distinct(Library_ID))


dfMetCovHu %>%  
  mutate(ReliableHuConT = fct_relevel(ReliableHuConT, c("Yes", "No"))) %>%
  ggplot( mapping = aes(x = reorder(GorID, PerCont), y = PerCont, color = Site)) +
  geom_pointrange(mapping = aes(ymin = LowLim, ymax = UpLim), alpha = .6, stroke = NA) +
  scale_colour_manual(values = colorRampPalette(c("yellow3", "darkmagenta", "turquoise2"))(16)) +
  geom_hline(yintercept = 1, color = "grey60", size =.25, linetype = "dashed") + 
  facet_grid(~ReliableHuConT, scales = "free", space = "free") +
  ylab("% human contamination") + xlab("") + 
  themeMAE + theme(axis.text.x = element_text(angle=45, vjust = 0.5), panel.grid.major.x  = element_blank(),
                   legend.position = "bottom", legend.background = element_rect(fill = "#f0f0f0"))


```


# Downsampling - %hDNA

Here I will work with samples from SRSLY2 and SRSLY3 batches only. SRSLY1 not included.

```{r}

df_downSRLY2 <- fread("../Analyses/02_SummaryMetrics/WG/SumMetrics_SRSLY2Down_WG_GRCh38_IDsAlluniqFASTQ.txt", header = TRUE)
df_downSRLY3 <- fread("../Analyses/02_SummaryMetrics/WG/SumMetrics_SRSLY3Down_WG_GRCh38_IDsAllunique.txt", header = TRUE)
dfDownMerged <- rbind(df_downSRLY2, df_downSRLY3)
head(dfDownMerged)
```


```{r}
dfDownMerged %>% mutate(ReliableReads = Filtered_Reads,
              MappedReads = Mapped_Reads - Filtered_Reads,
              ProductionReads = Production_Reads - Mapped_Reads) %>%
  select(GorID, Library_ID, Sample_ID, ProductionReads, MappedReads, ReliableReads) %>%
  gather(key, value, -GorID, -Library_ID, -Sample_ID) %>%
  mutate(key = fct_relevel(key, ReadsOrder),
         ID = paste(GorID, Library_ID, sep = '_')) %>%
  ggplot(aes(x = ID, y = value, fill = key, label = key)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::label_number()) +
  ylab("Number of Reads") +
  scale_fill_manual(values = paletteCaptSeq) +
  themeMAE +
  theme(plot.title.position = "plot",
        legend.position = "bottom", legend.direction = "horizontal", legend.title = element_blank(), 
        panel.grid.major.x  = element_blank(),
        axis.text.x = element_text(angle=45, hjust = 1), legend.background = element_rect(fill = "#f0f0f0", color = NA))
```

Get %hDNA per library

```{r}
hDNA <- dfDownMerged %>% mutate(ReliableReads = Filtered_Reads*100,
                        MappedReads = (Mapped_Reads - Filtered_Reads)*100,
                        ProductionReads = (Production_Reads - Mapped_Reads)*100,
                        eDNA = (Filtered_Reads/Production_Reads)*100,
                        AverageCoverage=Filtered_BASES/3272116950)
write_xlsx(hDNA,"../Analyses/02_SummaryMetrics/WG/SRSLY2and3_hDNACoverage.xlsx")


dfDownMerged %>% mutate(ReliableReads = Filtered_Reads*100,
                        MappedReads = (Mapped_Reads - Filtered_Reads)*100,
                        ProductionReads = (Production_Reads - Mapped_Reads)*100,
                        eDNA = (Filtered_Reads/Production_Reads)*100,
                        AverageCoverage=Filtered_BASES/3272116950) %>%
  mutate(ID = paste(GorID, Library_ID, sep = '_')) %>%
  select(GorID, Library_ID, Sample_ID, ID, eDNA, AverageCoverage) %>%
  mutate(GorillaID = GorID) %>%
  separate(GorID, 
           into = c("Site", "SampleNumber"), 
           sep = "(?<=[A-Za-z])(?=[0-9])"
           ) %>% 
  group_by(Site) %>%
  summarise(median_Coverage = median(AverageCoverage),
                    median_hDNA = median(eDNA),
                    totalLibs = n_distinct(Library_ID)) %>%
  ggplot( aes(x = median_Coverage, y = median_hDNA, label = Site, color = Site))+
  geom_point(aes(size = totalLibs)) +
  geom_text_repel() + themeMAE
```


# Data of libraries that I keep after HuConTest filtering


# Map of samples

Map of samples left after removing contaminated samples
```{r}
NotContSampl <- dfMetCovHu %>% filter(Contaminated == "No") %>%
  group_by(Species, Site) %>%
  summarise(n_distinct(BCN_ID), `Site Lat`, `Site Long`) %>%
  as.data.frame() %>% unique()
NotContSampl$`Site Lat` <- as.numeric(NotContSampl$`Site Lat`)
NotContSampl$`Site Long` <- as.numeric(NotContSampl$`Site Long`)

# All sites map
BaseMap + 
  geom_point(data = NotContSampl, 
                  aes(x = `Site Long`, y = `Site Lat`, group = Site)) +
  geom_text_repel(data = NotContSampl, aes(x = `Site Long`, y = `Site Lat`, label = Site), size = 3,
        nudge_x = c(-0.5, -0.5, -0.5, .5, .5), nudge_y = c(0.5, -0.5, 0.5, 0.5, -0.5)) +
  coord_fixed(xlim = c(4.5, 20), ylim = c(-5, 10)) + 
  themeMAE + theme(legend.position = c(.2,.05), legend.direction = "horizontal", 
                   legend.background = element_rect(fill = "#f0f0f0", color = NA), 
                   axis.text = element_blank()) + xlab("") + ylab("")


```


Tune my data for this
```{r, out.width = "100%"}

pies <- dfMetCovHu %>% filter(Contaminated == "No") %>%
  mutate(PowerRangers = case_when(AverageCoverage < 1 ~ "< 1x",
                                  AverageCoverage >= 1 & AverageCoverage < 5 ~ "< 5x",
                                  AverageCoverage >=5 & AverageCoverage < 10 ~ "< 10x",
                                  TRUE ~ "> 10x")) %>%
  select(`Site Long`, `Site Lat`, PowerRangers, LibraryID, Species, Site, AverageCoverage) %>%
  group_by(Site, PowerRangers) %>%
  summarise(n = n_distinct(LibraryID), Long=`Site Long`, Lat=`Site Lat`) %>%
  unique() %>% 
  spread(PowerRangers, n) %>% replace(is.na(.), 0) %>%
  mutate(sum = `> 10x` + `< 10x` + `< 1x` + `< 5x`) %>%
  relocate(`< 10x`, .after = `< 5x`)
pies$Long <- as.numeric(pies$Long)
pies$Lat <- as.numeric(pies$Lat)
pies$`> 10x` <- as.numeric(pies$`> 10x`)
pies$`< 10x` <- as.numeric(pies$`< 10x`)
pies$`< 1x` <- as.numeric(pies$`< 1x`)
pies$`< 5x` <- as.numeric(pies$`< 5x`)
pies

#New column 1:n
n <- nrow(pies)
pies$region <- factor(1:n)

#Radius column
pies$radius <- 6 * abs(rnorm(n))

#Rename CovRatio columns
names(pies)[4] <- "Less_1x"
names(pies)[5] <- "Less_5x"
names(pies)[6] <- "Less_10x"
names(pies)[7] <- "More_10x"

pies

library(scatterpie)

BaseMap +
  geom_scatterpie(data = pies, 
                    aes(x = Long, y = Lat, r = sqrt(sum)/5),
                    cols = c("Less_1x", "Less_5x", "Less_10x", "More_10x"), color=NA,
                    alpha = 0.9) +
  scale_fill_manual(
        breaks = c("Less_1x", "Less_5x", "Less_10x", "More_10x"),
        labels = c("< 1x", "< 5x", "< 10x", "> 10x"),
        #levels = c("Less_1x", "Less_5x", "Less_10x", "More_10x"),
        values = c("More_10x" = "#3366CC",
                   "Less_10x" = "#597EAD",
                   "Less_1x" = "#7E958E",
                   "Less_5x" = "#A4AD6F")
        ) +
  geom_text_repel(data = pies, aes(x = Long, y = Lat, label = Site), nudge_y = 1, nudge_x = .5, segment.color = 'grey60') +
  themeMAE + theme(legend.position = c(.1,.2), legend.background = element_blank(), legend.title = element_blank())


```

```{r, out.width="100%"}
dfMetCovHu %>% filter(Contaminated == "No") %>%
  mutate(PowerRangers = case_when(AverageCoverage < 1 ~ "< 1x",
                                  AverageCoverage >= 1 & AverageCoverage < 5 ~ "< 5x",
                                  AverageCoverage >=5 & AverageCoverage < 10 ~ "< 10x",
                                  TRUE ~ "> 10x")) %>%
  select(`Site Long`, `Site Lat`, PowerRangers, LibraryID, Species, Site, AverageCoverage) %>%
  group_by(Species, Site) %>% #filter(Species == "Cross River Gorilla") %>%
  summarise(n = n_distinct(LibraryID), Long=`Site Long`, Lat=`Site Lat`) %>% unique() %>%
  mutate(NewLat = case_when(Site == "Afi Mountain" ~ 7.00024,
                             Site == "Boshi" ~ 9.10927,
                             Site == "Kagwene" ~ 6.64026,
                             Site == "Kenshi" ~ 5.89474,
                             Site == "Mbe" ~ 5.64001,
                             TRUE ~ Lat),
         NewLong = case_when(Site == "Afi Mountain" ~ 8.1356,
                            Site == "Boshi" ~ 9.90989,
                            Site == "Kagwene" ~ 10.47569,
                            Site == "Kenshi" ~ 10.48486,
                            Site == "Mbe" ~ 8.32921,
                             TRUE ~ Long))




pies2 <- dfMetCovHu %>% filter(Contaminated == "No") %>%
  mutate(PowerRangers = case_when(AverageCoverage < 1 ~ "< 1x",
                                  AverageCoverage >= 1 & AverageCoverage < 5 ~ "< 5x",
                                  AverageCoverage >=5 & AverageCoverage < 10 ~ "< 10x",
                                  TRUE ~ "> 10x")) %>%
  select(`Site Long`, `Site Lat`, PowerRangers, LibraryID, Species, Site, AverageCoverage) %>%
  group_by(Site, PowerRangers) %>%
  summarise(n = n_distinct(LibraryID), Long=`Site Long`, Lat=`Site Lat`) %>%
  mutate(NewLat = case_when(Site == "Afi Mountain" ~ 9.50122,
                             Site == "Boshi" ~ 9.43587,
                             Site == "Kagwene" ~ 8.09406,
                             Site == "Kenshi" ~ 5.65441,
                             Site == "Mbe" ~ 5.35581,
                             TRUE ~ Lat),
         NewLong = case_when(Site == "Afi Mountain" ~ 7.69632,
                            Site == "Boshi" ~ 10.23932,
                            Site == "Kagwene" ~ 11.79397,
                            Site == "Kenshi" ~ 11.17677,
                            Site == "Mbe" ~ 8.79067,
                             TRUE ~ Long)) %>%
  unique() %>% 
  spread(PowerRangers, n) %>% replace(is.na(.), 0) %>%
  mutate(sum = `> 10x` + `< 10x` + `< 1x` + `< 5x`) %>%
  relocate(`< 10x`, .after = `< 5x`) 
pies2$NewLong <- as.numeric(pies2$NewLong)
pies2$NewLat <- as.numeric(pies2$NewLat)
pies2$`> 10x` <- as.numeric(pies2$`> 10x`)
pies2$`< 10x` <- as.numeric(pies2$`< 10x`)
pies2$`< 1x` <- as.numeric(pies2$`< 1x`)
pies2$`< 5x` <- as.numeric(pies2$`< 5x`)
pies2

#New column 1:n
n <- nrow(pies2)
pies2$region <- factor(1:n)

#Radius column
pies2$radius <- 6 * abs(rnorm(n))

#Rename CovRatio columns
names(pies2)[6] <- "Less_1x"
names(pies2)[7] <- "Less_5x"
names(pies2)[8] <- "Less_10x"
names(pies2)[9] <- "More_10x"

pies2

library(scatterpie)

BaseMap +
  geom_scatterpie(data = pies2, 
                    aes(x = NewLong, y = NewLat, r = sqrt(sum)/5),
                    cols = c("Less_1x", "Less_5x", "Less_10x", "More_10x"), color=NA,
                    alpha = 0.9) +
  scale_fill_manual(
        breaks = c("Less_1x", "Less_5x", "Less_10x", "More_10x"),
        labels = c("< 1x", "< 5x", "< 10x", "> 10x"),
        #levels = c("Less_1x", "Less_5x", "Less_10x", "More_10x"),
        values = c("More_10x" = "#3366CC",
                   "Less_10x" = "#597EAD",
                   "Less_1x" = "#7E958E",
                   "Less_5x" = "#A4AD6F")
        ) +
  geom_text_repel(data = pies2, aes(x = Long, y = Lat, label = Site), nudge_y = 1, nudge_x = .5, segment.color = 'grey60') +
  themeMAE + theme(legend.position = c(.1,.2), legend.background = element_blank(), legend.title = element_blank())

#dev.print(pdf, "my_plot.pdf")
```


```{r}
dfMetCovHu %>% filter(Contaminated == "No") %>%
  mutate(PowerRangers = case_when(AverageCoverage < 1 ~ "< 1x",
                                  AverageCoverage >= 1 & AverageCoverage < 5 ~ "< 5x",
                                  AverageCoverage >=5 & AverageCoverage < 10 ~ "< 10x",
                                  TRUE ~ "> 10x")) %>%
  filter(AverageCoverage >= 7) %>% select(GorID, Library_ID, PerCont, Species, Site, eDNA, AverageCoverage)

dfMetCovHu %>% filter(Contaminated == "No") %>%
  mutate(PowerRangers = case_when(AverageCoverage < 1 ~ "< 1x",
                                  AverageCoverage >= 1 & AverageCoverage < 5 ~ "< 5x",
                                  AverageCoverage >=5 & AverageCoverage < 10 ~ "< 10x",
                                  TRUE ~ "> 10x")) %>%
  filter(AverageCoverage >= 7 & AverageCoverage < 10) %>% select(GorID, Library_ID, PerCont, Species, Site, eDNA, AverageCoverage)

```

# Hair + WGGorillas dataset

```{r}
WGG <- read_xlsx("../Analyses/00_Metadata_ALL_Gorillas//AllGors_data_SRAs.xlsx", sheet = "Sheet1", 
                    col_types = c("skip", "text", "skip", "skip", "text", "text", "text", "skip", "skip",
                                  "text", "skip", "text", "text", "text", "skip", "skip", "text", 
                                  "numeric", "skip", "skip", "skip", "skip", "skip", "skip", "numeric", "skip", "skip", "text", "text"))
head(WGG)
```

```{r}

blood <- WGG %>% 
  mutate(GorID = Folder,
         Species = case_when(
           Species == "Gbg" ~ "Grauer's Gorilla",
           Species == "Gbb" ~ "Mountain Gorilla",
           Species == "Ggg" ~ "Western Lowland Gorilla",
           TRUE ~ "Cross River Gorilla"),
         Contaminated = case_when(
           PerHuConTest < 1 ~ "No",
           TRUE ~ "Yes"),
         AverageCoverage = MAEs_Coverage,
         Region = Origin_V2) %>%
  filter(KeptAfterRelatednessQualityCheck == "Yes") %>%
  filter(!(GorID == "Gbg-Victoria" | GorID == "Gbg-Dunia" | GorID == "Gbg-Victoria" | GorID == "Gbg-Mukokya" | GorID == "Gbg-Amahoro" | 
                               GorID == "Gbb-Maisha" | GorID == "Gbb-Zirikana")) %>%
  select(GorID, Species, AverageCoverage, Region, Country, Contaminated, Birth_Origin) %>% 
  mutate(SampleType = "Blood")

```


```{r}
hair <- dfMetCovHu %>% filter(!(SeqBatch == "SRSLY1_FASTP")) %>%
  select(GorID, Species, AverageCoverage, Contaminated, Region, Country) %>%
  mutate(Birth_Origin = "Wild born",
         SampleType = "Hair")
```

```{r}
#merge dataframes
allGors_Country <- rbind(blood, hair)
```


Which is the lowest coverage?
```{r}
allGors_Country %>% arrange(AverageCoverage)
```

Blood + Hair - All 4 subspecies 

```{r}

AllGors <- allGors_Country
#write_xlsx(AllGors, "pcangsd/AllGors_MD.xlsx")
allGors_Country %>% 
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))
```

Blood + Hair - All 4 subspecies - Not HuContamination

```{r}
allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))
```

Blood + Hair - All 4 subspecies - Not HuContamination - Above 0.5x

```{r}
allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))
```

Blood + Hair - Western Gorillas - Not HuCon - Above 0.5x
```{r}

allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  filter(Species == "Western Lowland Gorilla" | Species == "Cross River Gorilla" | Species == "Unknown") %>%
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))

```

Blood + Hair - Western Lowland Gorillas (+ unknown) - Not HuCon - above 0.5x
```{r}
allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  filter(Species == "Western Lowland Gorilla" | Species == "Unknown") %>%
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))
```

Blood + Hair - Cross River Gorillas (+ unknown) - Not HuCon - above 0.5x
```{r}
allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  filter(Species == "Cross River Gorilla" | Species == "Unknown") %>%
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))

allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  filter(Species == "Western Lowland Gorilla") %>% 
  filter(SampleType == "Hair")
```

Hair - Western Gorillas (+ unknown) - Not HuCon - above 0.5x
```{r}
allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  filter(SampleType == "Hair") %>%                  #Keep only Hair samples
  filter(Species == "Western Lowland Gorilla" | Species == "Cross River Gorilla" | Species == "Unknown") %>%
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))
```

Hair - Western Gorillas (+ unknown) - Not HuCon - above 0.5x
```{r}
allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  filter(SampleType == "Hair") %>%                  #Keep only Hair samples
  filter(Species == "Western Lowland Gorilla" | Species == "Unknown") %>%
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))
```

Hair - Cross River Gorillas (+ unknown) - Not HuCon - above 0.5x
```{r}
allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  filter(SampleType == "Hair") %>%                  #Keep only Hair samples
  filter(Species == "Cross River Gorilla" | Species == "Unknown") %>%
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))
```

Hair - Cross River Gorillas (+ unknown) - Not HuCon - above 0.5x
```{r}
allGors_Country %>% filter(Contaminated == "No") %>% #Keep not-HuCon samples
  filter(AverageCoverage >= 0.5) %>%                #Filter by depth
  filter(SampleType == "Hair") %>%                  #Keep only Hair samples
  filter(Species == "Cross River Gorilla") %>%
  summarise(n = length(GorID),
            mean = mean(AverageCoverage), median = median(AverageCoverage),
            min = min(AverageCoverage), max = max(AverageCoverage))
```

